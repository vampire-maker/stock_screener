#!/usr/bin/env python3
"""
æ£€æŸ¥æˆåŠŸè‚¡ç¥¨æ˜¯å¦æ»¡è¶³è°ƒæ•´åçš„ç­–ç•¥æ¡ä»¶
"""

import json
import pandas as pd
import numpy as np

# åŠ è½½é€‰è‚¡ç»“æœ
with open('main_force_burial_result_20251210_145330.json', 'r', encoding='utf-8') as f:
    screening_data = json.load(f)

# æˆåŠŸè‚¡ç¥¨åˆ—è¡¨ï¼ˆæ”¶ç›Š>3%ï¼‰
successful_stocks = [
    '600730.SH',  # ä¸­å›½é«˜ç§‘ +16.47%
    '603306.SH',  # åæ‡‹ç§‘æŠ€ +14.64%
    '002438.SZ',  # æ±Ÿè‹ç¥é€š +10.11%
    '002478.SZ',  # å¸¸å®è‚¡ä»½ +9.03%
    '002865.SZ',  # é’§è¾¾è‚¡ä»½ +7.37%
    '300982.SZ',  # è‹æ–‡ç”µèƒ½ +7.06%
    '603663.SH',  # ä¸‰ç¥¥æ–°æ +6.86%
    '002448.SZ',  # ä¸­åŸå†…é… +6.73%
    '603269.SH',  # æµ·é¸¥è‚¡ä»½ +6.59%
    '000506.SZ',  # æ‹›é‡‘é»„é‡‘ +6.24%
    '002130.SZ',  # æ²ƒå°”æ ¸æ +3.16%
    '603399.SH',  # æ°¸æ‰é”‚ä¸š
    '600354.SH',  # æ•¦ç…Œç§ä¸š
    '000422.SZ',  # æ¹–åŒ—å®œåŒ–
    '002708.SZ',  # å…‰æ´‹è‚¡ä»½
    '300277.SZ',  # æµ·è”è®¯
    '688502.SH',  # èŒ‚è±å…‰å­¦
]

# è°ƒæ•´åçš„ç­–ç•¥æ¡ä»¶
optimized_conditions = {
    'max_deviation': 2.0,  # ä¹–ç¦»ç‡â‰¤2%
    'min_pct': 2.0,        # æ¶¨å¹…â‰¥2%
    'min_amount_wan': 50000,  # æˆäº¤é¢â‰¥5äº¿ï¼ˆä¸‡å…ƒï¼‰
    'min_turnover_rate': 5.0,  # æ¢æ‰‹ç‡â‰¥5%
}

# åˆ›å»ºå­—å…¸å¿«é€ŸæŸ¥æ‰¾
stocks_dict = {stock['code']: stock for stock in screening_data['stocks']}

print("ğŸ“Š æˆåŠŸè‚¡ç¥¨ä¸ä¼˜åŒ–ç­–ç•¥åŒ¹é…åº¦åˆ†æ")
print("=" * 80)
print(f"\nä¼˜åŒ–åçš„ç­–ç•¥æ¡ä»¶ï¼š")
print(f"1. ä¹–ç¦»ç‡ â‰¤ {optimized_conditions['max_deviation']}%")
print(f"2. æ¶¨å¹… â‰¥ {optimized_conditions['min_pct']}%")
print(f"3. æˆäº¤é¢ â‰¥ {optimized_conditions['min_amount_wan']/10000:.1f}äº¿å…ƒ")
print(f"4. æ¢æ‰‹ç‡ â‰¥ {optimized_conditions['min_turnover_rate']}%\n")

# åˆ†ææ¯åªæˆåŠŸè‚¡ç¥¨
print(f"{'è‚¡ç¥¨ä»£ç ':<12} {'è‚¡ç¥¨åç§°':<10} {'æ”¶ç›Š%':<8} {'ä¹–ç¦»%':<8} {'æ¶¨å¹…%':<8} {'æ¢æ‰‹%':<8} {'æˆäº¤é¢(äº¿)':<12} {'æ»¡è¶³æ¡ä»¶':<10}")
print("-" * 80)

fully_satisfied = 0
partially_satisfied = 0
details = []

for stock_code in successful_stocks:
    if stock_code not in stocks_dict:
        continue

    stock = stocks_dict[stock_code]
    name = stock['name']
    change = stock['change']
    deviation = stock['deviation']
    turnover_rate = stock['turnover_rate']
    amount_wan = stock['amount_wan']
    amount_yi = amount_wan / 10000

    # æ£€æŸ¥æ»¡è¶³çš„æ¡ä»¶
    conditions_met = []
    if deviation <= optimized_conditions['max_deviation']:
        conditions_met.append('ä¹–ç¦»')
    if change >= optimized_conditions['min_pct']:
        conditions_met.append('æ¶¨å¹…')
    if amount_wan >= optimized_conditions['min_amount_wan']:
        conditions_met.append('æˆäº¤é¢')
    if turnover_rate >= optimized_conditions['min_turnover_rate']:
        conditions_met.append('æ¢æ‰‹')

    # ç»Ÿè®¡
    if len(conditions_met) == 4:
        fully_satisfied += 1
        status = "âœ… å…¨éƒ¨"
    elif len(conditions_met) >= 2:
        partially_satisfied += 1
        status = f"âš ï¸ {len(conditions_met)}/4"
    else:
        status = f"âŒ {len(conditions_met)}/4"

    details.append({
        'code': stock_code,
        'name': name,
        'change': change,
        'deviation': deviation,
        'amount_yi': amount_yi,
        'turnover_rate': turnover_rate,
        'met_count': len(conditions_met)
    })

    # æ˜¾ç¤ºæ”¶ç›Šï¼ˆä»ä¹‹å‰çš„åˆ†æè·å–ï¼‰
    returns_map = {
        '600730.SH': 16.47, '603306.SH': 14.64, '002438.SZ': 10.11,
        '002478.SZ': 9.03, '002865.SZ': 7.37, '300982.SZ': 7.06,
        '603663.SH': 6.86, '002448.SZ': 6.73, '603269.SH': 6.59,
        '000506.SZ': 6.24, '002130.SZ': 3.16
    }
    return_pct = returns_map.get(stock_code, 3.0)

    print(f"{stock_code:<12} {name:<10} {return_pct:<8.1f} {deviation:<8.2f} {change:<8.2f} {turnover_rate:<8.2f} {amount_yi:<12.1f} {status:<10}")

print("\n" + "=" * 80)
print(f"åˆ†æç»“æœï¼š")
print(f"1. å®Œå…¨æ»¡è¶³ä¼˜åŒ–æ¡ä»¶çš„è‚¡ç¥¨ï¼š{fully_satisfied} åª")
print(f"2. éƒ¨åˆ†æ»¡è¶³ä¼˜åŒ–æ¡ä»¶çš„è‚¡ç¥¨ï¼š{partially_satisfied} åª")
print(f"3. æˆåŠŸç‡ï¼š{(fully_satisfied + partially_satisfied) / len(successful_stocks) * 100:.1f}%")

# è¯¦ç»†åˆ†ææœªæ»¡è¶³æ¡ä»¶çš„æƒ…å†µ
print("\nğŸ“‰ ä¸æ»¡è¶³æ¡ä»¶çš„æƒ…å†µåˆ†æï¼š")
print("-" * 60)

failed_conditions = {
    'ä¹–ç¦»ç‡>2%': 0,
    'æ¶¨å¹…<2%': 0,
    'æˆäº¤é¢<5äº¿': 0,
    'æ¢æ‰‹ç‡<5%': 0
}

for stock_code in successful_stocks:
    if stock_code not in stocks_dict:
        continue
    stock = stocks_dict[stock_code]

    if stock['deviation'] > optimized_conditions['max_deviation']:
        failed_conditions['ä¹–ç¦»ç‡>2%'] += 1
    if stock['change'] < optimized_conditions['min_pct']:
        failed_conditions['æ¶¨å¹…<2%'] += 1
    if stock['amount_wan'] < optimized_conditions['min_amount_wan']:
        failed_conditions['æˆäº¤é¢<5äº¿'] += 1
    if stock['turnover_rate'] < optimized_conditions['min_turnover_rate']:
        failed_conditions['æ¢æ‰‹ç‡<5%'] += 1

for condition, count in failed_conditions.items():
    print(f"{condition}: {count} åªè‚¡ç¥¨")

print("\nğŸ’¡ ä¼˜åŒ–å»ºè®®è°ƒæ•´ï¼š")
print("-" * 60)

# åŸºäºå®é™…æ•°æ®ç»™å‡ºæ›´åˆç†çš„å‚æ•°
deviation_values = [s['deviation'] for s in details if s['deviation'] > 0]
change_values = [s['change'] for s in details]
amount_values = [s['amount_yi'] for s in details]
turnover_values = [s['turnover_rate'] for s in details]

print(f"åŸºäºæˆåŠŸè‚¡ç¥¨çš„æ•°æ®åˆ†å¸ƒï¼š")
print(f"1. ä¹–ç¦»ç‡ï¼šä¸­ä½æ•°={np.median(deviation_values):.2f}%ï¼Œå»ºè®®ä¿æŒâ‰¤{np.percentile(deviation_values, 75):.1f}%")
print(f"2. æ¶¨å¹…ï¼šä¸­ä½æ•°={np.median(change_values):.2f}%ï¼Œå»ºè®®â‰¥{np.percentile(change_values, 25):.1f}%")
print(f"3. æˆäº¤é¢ï¼šä¸­ä½æ•°={np.median(amount_values):.1f}äº¿ï¼Œå»ºè®®â‰¥{np.percentile(amount_values, 25):.1f}äº¿")
print(f"4. æ¢æ‰‹ç‡ï¼šä¸­ä½æ•°={np.median(turnover_values):.2f}%ï¼Œå»ºè®®â‰¥{np.percentile(turnover_values, 25):.1f}%")

print("\nğŸ¯ æœ€ç»ˆå»ºè®®å‚æ•°ï¼š")
print("1. ä¹–ç¦»ç‡ â‰¤ 2.5%ï¼ˆç¨å¾®æ”¾å®½ï¼‰")
print("2. æ¶¨å¹… â‰¥ 2.5%ï¼ˆä¿æŒï¼‰")
print("3. æˆäº¤é¢ â‰¥ 3.5äº¿ï¼ˆæ”¾å®½ä¸€äº›ï¼‰")
print("4. æ¢æ‰‹ç‡ â‰¥ 4.5%ï¼ˆç•¥å¾®æ”¾å®½ï¼‰")

print("\nâš ï¸ é‡è¦å‘ç°ï¼š")
print("- å¤§éƒ¨åˆ†æˆåŠŸè‚¡ç¥¨å¹¶ä¸å®Œå…¨ç¬¦åˆä¸¥æ ¼çš„ä¼˜åŒ–æ¡ä»¶")
print("- è¯´æ˜ç­–ç•¥æˆåŠŸå¯èƒ½æ›´å¤šä¾èµ–äºé¢˜æã€æ—¶æœºç­‰å…¶ä»–å› ç´ ")
print("- å»ºè®®ä¿æŒä¸€å®šçµæ´»æ€§ï¼Œé¿å…è¿‡åº¦ä¼˜åŒ–")